name: CI / Test and Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop] # PRãƒˆãƒªã‚¬ãƒ¼æ™‚ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿

jobs:
  test:
    name: Run Tests and Check Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # 1. Vitestã‚’å®Ÿè¡Œã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼ˆlcov.infoã‚’å«ã‚€ï¼‰ã‚’ç”Ÿæˆ
      - name: Run Vitest and Check 100% Coverage
        # 100%æœªæº€ã®å ´åˆã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§CIãŒå¤±æ•—ã—ã¾ã™
        run: npm run test:coverage

      # 2. (æ¨å¥¨) ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’GitHub Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # CIçµæœã®ç¢ºèªã‚„ãƒ‡ãƒãƒƒã‚°ã«å½¹ç«‹ã¡ã¾ã™
      - name: Upload Coverage Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vitest-coverage-report
          path: coverage/lcov.info
          if-no-files-found: error # lcov.infoãŒãªã„å ´åˆã¯CIã‚’å¤±æ•—ã•ã›ã‚‹

      # 3. PRã‚³ãƒ¡ãƒ³ãƒˆã«ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’æŠ•ç¨¿ (â˜…ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒéµã§ã™)
      # MishaKav/pytest-coverage-comment Actionã¯LCOVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã‚Œã¾ã™
      - name: Comment PR with Coverage Summary
        # pull_requestã‚¤ãƒ™ãƒ³ãƒˆã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«åˆ¶é™ã—ã¾ã™
        if: github.event_name == 'pull_request'
        uses: MishaKav/pytest-coverage-comment@main
        with:
          # VitestãŒç”Ÿæˆã—ãŸLCOVãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
          coverage-path: coverage/lcov.info
          token: ${{ secrets.GITHUB_TOKEN }}
          # ã‚³ãƒ¡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
          title: ğŸ§ª Vitest Code Coverage Report
