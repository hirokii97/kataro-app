name: CI / Test and Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop] # PRãƒˆãƒªã‚¬ãƒ¼æ™‚ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿

jobs:
  test:
    name: Run Tests and Check Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # 1. Vitestã‚’å®Ÿè¡Œã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼ˆlcov.infoã‚’å«ã‚€ï¼‰ã‚’ç”Ÿæˆ
      - name: Run Vitest and Check 100% Coverage
        # 100%æœªæº€ã®å ´åˆã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§CIãŒå¤±æ•—ã—ã¾ã™
        run: npm run test:coverage

      # 2. å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã‚ãšã«PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤º
      - name: Post Coverage Report to PR
        # ğŸ’¡ PRã®å ´åˆã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ã‚ˆã†æ¡ä»¶ã‚’è¨­å®š
        if: github.event_name == 'pull_request'

        # ğŸ’¡ lcov.infoãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Šã€Markdownãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        # Codecovã®ä»£æ›¿ã¨ã—ã¦ã€ç‰¹å®šã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
        uses: pet-locker/jest-coverage-commenter@v1.2.0
        with:
          # Vitestã®è¨­å®šã§ç”Ÿæˆã•ã‚ŒãŸlcovãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š
          coverage-summary-path: "coverage/lcov.info"

          # GitHubã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ¨™æº–ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ï¼‰
          # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™ãŒã‚ã‚‹ãŸã‚ã€å¤–éƒ¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ä¸è¦
          github-token: ${{ secrets.GITHUB_TOKEN }}
